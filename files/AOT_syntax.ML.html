<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹AOT_syntax.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹AOT_syntax.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_binder_trans</span> <span class="entity">thy</span> <span class="entity">bnd</span> <span class="entity">syntaxConst</span> <span class="main">=</span>
  <span class="main">(</span>Lexicon.mark_const <span class="main">(</span>Sign.full_name <span class="entity">thy</span> <span class="entity">bnd</span><span class="main">)</span><span class="main">,</span>
   K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">trms</span> <span class="main">=&gt;</span> Term.list_comb <span class="main">(</span>Const <span class="main">(</span><span class="entity">syntaxConst</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">,</span><span class="entity">trms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">AOT_VariableKind</span> <span class="main">=</span> <span class="entity">AOT_Variable</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>term*term<span class="main">)</span> option <span class="main">|</span> <span class="entity">AOT_MetaVariable</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AOT_VariablePrefix</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span><span class="entity">AOT_VariableKind</span>*string<span class="main">)</span> Symtab.table
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="comment1">(* TODO: probably better to remove conflicts than to ignore them *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span>K true<span class="main">)</span>
<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AOT_PremiseSetPrefix</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> unit Symtab.table
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span>K true<span class="main">)</span>
<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AOT_Constraints</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span>term*term<span class="main">)</span> Symtab.table
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x'</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">y'</span><span class="main">)</span>
<span class="main">)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AOT_Restriction</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span>term*term<span class="main">)</span> Symtab.table
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x'</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">y'</span><span class="main">)</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_IsPremiseSetPrefix</span> <span class="entity">ctxt</span> <span class="main">=</span> Local_Theory.raw_theory_result
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">(</span>AOT_PremiseSetPrefix.get <span class="entity">thy</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
  |&gt; fst |&gt; Symtab.lookup #&gt; Option.isSome

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_of_sort</span> <span class="entity">S</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">class</span> <span class="main">=</span> Syntax.const o Lexicon.mark_class<span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">classes</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> <span class="main">=</span> <span class="entity">class</span> <span class="entity">c</span>
      <span class="main">|</span> <span class="entity">classes</span> <span class="main">(</span><span class="entity">c</span> :: <span class="entity">cs</span><span class="main">)</span> <span class="main">=</span> Syntax.const <span class="inner_quoted">"_classes"</span> $ <span class="entity">class</span> <span class="entity">c</span> $ <span class="entity">classes</span> <span class="entity">cs</span>
      <span class="main">|</span> <span class="entity">classes</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Unexpected."</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">S</span> <span class="main">=</span> dummyS <span class="keyword2"><span class="keyword">then</span></span> Syntax.const <span class="inner_quoted">"_dummy_sort"</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">S</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> Syntax.const <span class="inner_quoted">"_topsort"</span>
      <span class="main">|</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">class</span> <span class="entity">c</span>
      <span class="main">|</span> <span class="entity">cs</span> <span class="main">=&gt;</span> Syntax.const <span class="inner_quoted">"_sort"</span> $ <span class="entity">classes</span> <span class="entity">cs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_of</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      Term.list_comb <span class="main">(</span>Syntax.const <span class="main">(</span>Lexicon.mark_type <span class="entity">a</span><span class="main">)</span><span class="main">,</span> map <span class="entity">term_of</span> <span class="entity">Ts</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">term_of</span> <span class="main">(</span>TFree <span class="main">(</span><span class="inner_quoted">"'_dummy_"</span><span class="main">,</span><span class="entity">sort</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_dummy_ofsort"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">term_of_sort</span> <span class="entity">sort</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">term_of</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> TFree <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">print</span><span class="antiquote">}</span></span></span></span></span></span></span></span> <span class="entity">t</span><span class="main">;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TYPE <span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">term_of</span> <span class="main">(</span>TVar <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">""</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fetchTermCategory</span> <span class="entity">ctxt</span> <span class="main">=</span> Local_Theory.raw_theory_result <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
  <span class="main">(</span>Symtab.lookup <span class="main">(</span>AOT_VariablePrefix.get <span class="entity">thy</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> |&gt; fst
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">maybeGetConstraint</span> <span class="entity">ctxt</span> <span class="entity">unary</span> <span class="entity">name</span> <span class="main">=</span> Local_Theory.raw_theory_result <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> 
   <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">unary</span> <span class="keyword2"><span class="keyword">then</span></span> Option.map fst <span class="keyword2"><span class="keyword">else</span></span> Option.map snd<span class="main">)</span>
    <span class="main">(</span>Symtab.lookup <span class="main">(</span>AOT_Constraints.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> |&gt; fst
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">getConstraint</span> <span class="entity">ctxt</span> <span class="entity">unary</span> <span class="entity">name</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">maybeGetConstraint</span> <span class="entity">ctxt</span> <span class="entity">unary</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">|</span>
   <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Unknown type category: "</span> ^ <span class="entity">name</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fetchTermConstraint</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">unary</span> <span class="main">=</span>
  Local_Theory.raw_theory_result <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span>
    <span class="main">(</span>Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">meta</span><span class="main">,</span> <span class="entity">category</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">meta</span><span class="main">,</span> <span class="entity">getConstraint</span> <span class="entity">ctxt</span> <span class="entity">unary</span> <span class="entity">category</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span>Symtab.lookup o AOT_VariablePrefix.get<span class="main">)</span> <span class="entity">thy</span> <span class="main">(</span>hd <span class="main">(</span>Symbol.explode <span class="entity">name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span>
<span class="main">)</span> <span class="entity">ctxt</span> |&gt; fst

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register_constraint</span> <span class="main">(</span><span class="entity">name</span><span class="main">:</span>string<span class="main">,</span> <span class="main">(</span><span class="entity">unaryConstraint</span><span class="main">,</span><span class="entity">naryConstraint</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">=</span> <span class="main">(</span>
<span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trmOf</span> <span class="entity">constr</span> <span class="main">=</span> <span class="entity">term_of</span> <span class="main">(</span>Syntax.parse_typ <span class="main">(</span>Proof_Context.init_global <span class="entity">thy</span><span class="main">)</span> <span class="entity">constr</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unaryConstraint</span> <span class="main">=</span> <span class="entity">trmOf</span> <span class="entity">unaryConstraint</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">naryConstraint</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">naryConstraint</span> <span class="keyword2"><span class="keyword">of</span></span>
  <span class="main">(</span>SOME <span class="entity">constraint</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">trmOf</span> <span class="entity">constraint</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">unaryConstraint</span>
<span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> 
AOT_Constraints.map <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">(</span><span class="entity">unaryConstraint</span><span class="main">,</span> <span class="entity">naryConstraint</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">thy</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register_variable_name</span> <span class="entity">meta</span> <span class="main">(</span><span class="entity">category</span><span class="main">,</span> <span class="entity">prefices</span><span class="main">)</span> <span class="entity">thy</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">restr</span> <span class="main">=</span> <span class="main">(</span>Symtab.lookup <span class="main">(</span>AOT_Restriction.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">category</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">meta</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">AOT_MetaVariable</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">AOT_Variable</span> <span class="entity">restr</span>
<span class="keyword2"><span class="keyword">in</span></span>
   fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">prefix</span> <span class="main">=&gt;</span> AOT_VariablePrefix.map
      <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">prefix</span><span class="main">,</span> <span class="main">(</span><span class="entity">kind</span><span class="main">,</span> <span class="entity">category</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">prefices</span> <span class="entity">thy</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">AOT_register_variable_names</span>›</span></span>
  <span class="inner_quoted">"Register variable names for type categories."</span>
  <span class="main">(</span>Parse.and_list1 <span class="main">(</span><span class="main">(</span>Parse.short_ident --| Parse.$$$ <span class="inner_quoted">":"</span> <span class="main">)</span>
                    -- Scan.repeat1 Parse.short_ident<span class="main">)</span>
   &gt;&gt; <span class="main">(</span><span class="entity">Toplevel.theory</span> o <span class="main">(</span>fold <span class="main">(</span><span class="entity">register_variable_name</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">AOT_register_metavariable_names</span>›</span></span>
  <span class="inner_quoted">"Register meta-variable names for type categories."</span>
    <span class="main">(</span>Parse.and_list1 <span class="main">(</span><span class="main">(</span>Parse.short_ident --| Parse.$$$ <span class="inner_quoted">":"</span><span class="main">)</span>
                      -- Scan.repeat1 Parse.short_ident<span class="main">)</span>
     &gt;&gt; <span class="main">(</span><span class="entity">Toplevel.theory</span> o <span class="main">(</span>fold <span class="main">(</span><span class="entity">register_variable_name</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">AOT_register_premise_set_names</span>›</span></span>
  <span class="inner_quoted">"Register names for premise sets."</span>
  <span class="main">(</span>Scan.repeat1 Parse.short_ident
   &gt;&gt; <span class="main">(</span><span class="entity">Toplevel.theory</span> o fold
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">prefix</span> <span class="main">=&gt;</span> AOT_PremiseSetPrefix.map <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">prefix</span><span class="main">,</span><span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">AOT_register_type_constraints</span>›</span></span>
  <span class="inner_quoted">"Register constraints for term types."</span>
  <span class="main">(</span>Parse.and_list1 <span class="main">(</span><span class="main">(</span>Parse.short_ident --| Parse.$$$ <span class="inner_quoted">":"</span><span class="main">)</span>
                    -- <span class="main">(</span>Parse.typ -- Scan.option Parse.typ<span class="main">)</span><span class="main">)</span>
  &gt;&gt; <span class="main">(</span><span class="entity">Toplevel.theory</span> o fold <span class="entity">register_constraint</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decode_pos</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>Term_Position.decode <span class="entity">str</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">pos</span> <span class="main">=&gt;</span> <span class="entity">pos</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"expected position"</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unconstrain_var</span> <span class="main">(</span>Ast.Appl <span class="main">[</span>Ast.Constant <span class="inner_quoted">"_constrain"</span><span class="main">,</span> Ast.Variable <span class="entity">name</span><span class="main">,</span> Ast.Variable <span class="entity">pos</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">decode_pos</span> <span class="entity">pos</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">unconstrain_var</span> <span class="entity">ast</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Ast.AST <span class="main">(</span><span class="inner_quoted">"Expected position constrained variable."</span><span class="main">,</span> <span class="main">[</span><span class="entity">ast</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_constrained_var</span> <span class="entity">sx</span> <span class="main">=</span> <span class="main">(</span>Ast.Appl <span class="main">[</span>Ast.Constant <span class="inner_quoted">"_constrain"</span><span class="main">,</span> Ast.Variable <span class="main">(</span>Symbol_Pos.implode <span class="entity">sx</span><span class="main">)</span><span class="main">,</span> Ast.Variable <span class="main">(</span>Term_Position.encode <span class="main">(</span>Position.range_position <span class="main">(</span>Symbol_Pos.range <span class="entity">sx</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">implode_pos</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span>Symbol_Pos.implode_range <span class="main">(</span>Symbol_Pos.range <span class="entity">x</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span> |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span>Position.range_position <span class="entity">y</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">splitFormulaParts</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span> |&gt; <span class="entity">unconstrain_var</span> |&gt; Symbol_Pos.explode |&gt;
   Scan.finite Symbol_Pos.stopper <span class="main">(</span>Scan.repeat <span class="main">(</span>
  <span class="main">(</span>Scan.one <span class="main">(</span>Symbol_Pos.symbol #&gt; Symbol.is_letter<span class="main">)</span> --
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>Scan.repeat <span class="main">(</span>Symbol_Pos.$$ <span class="inner_quoted">"⇩"</span> -- <span class="main">(</span>Scan.one <span class="main">(</span>Symbol_Pos.symbol #&gt; Symbol.is_digit<span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> &gt;&gt; List.concat <span class="main">)</span>
  -- <span class="main">(</span>Scan.repeat <span class="main">(</span>Symbol_Pos.$$ <span class="inner_quoted">"'"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span>@<span class="entity">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseFormulaParts</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">splitFormulaParts</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">parts</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">parts</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">implode_pos</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">y</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Ast.AST <span class="main">(</span><span class="inner_quoted">"Expected one or more variable or term names."</span><span class="main">,</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">foldAppl</span> <span class="entity">const</span> <span class="main">=</span> List.rev #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">list</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">b</span> <span class="main">=&gt;</span> <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="entity">const</span><span class="main">)</span> <span class="main">[</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="entity">list</span><span class="main">)</span> <span class="main">(</span>hd <span class="entity">list</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dropConstraints</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dropConstraints</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">dropConstraints</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_constrainAbs"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dropConstraints</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">dropConstraints</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">dropConstraints</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dropConstraints</span> <span class="main">(</span><span class="entity">x</span>$<span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dropConstraints</span> <span class="entity">x</span> $ <span class="entity">dropConstraints</span> <span class="entity">y</span>
  <span class="main">|</span> <span class="entity">dropConstraints</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">constrain</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span> <span class="main">=</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_constrain"</span><span class="main">)</span> <span class="main">[</span>Ast.Variable <span class="entity">name</span><span class="main">,</span> Ast.Variable <span class="main">(</span>Term_Position.encode <span class="entity">pos</span><span class="main">)</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_split_exe_vars</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> <span class="entity">x</span> |&gt; <span class="entity">parseFormulaParts</span> |&gt; map <span class="entity">constrain</span> |&gt; 
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_AOT_term_var"</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> |&gt;
  <span class="entity">foldAppl</span> <span class="inner_quoted">"_AOT_exe_args"</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_split_lambda_args</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> <span class="entity">x</span> |&gt; <span class="entity">parseFormulaParts</span> |&gt; map <span class="entity">constrain</span> |&gt; 
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_AOT_var"</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> |&gt;
  <span class="entity">foldAppl</span> <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹Pair›</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_check_var</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> <span class="entity">x</span> |&gt; <span class="entity">parseFormulaParts</span> |&gt; map <span class="entity">constrain</span> |&gt;
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_AOT_var"</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Ast.AST <span class="main">(</span><span class="inner_quoted">"Expected single variable."</span><span class="main">,</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseVar</span> <span class="entity">unary</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">var</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ Free <span class="main">_</span><span class="main">]</span> <span class="main">=</span>
        Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">var</span> $ <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fetchTermConstraint</span> <span class="entity">ctxt</span> <span class="entity">x</span> <span class="entity">unary</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="main">(</span><span class="entity">AOT_MetaVariable</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected variable prefix, but got metavariable prefix."</span><span class="main">,</span> <span class="main">[</span><span class="entity">var</span><span class="main">]</span><span class="main">)</span>
          <span class="main">|</span> SOME <span class="main">(</span><span class="entity">AOT_Variable</span> <span class="main">_</span><span class="main">,</span> <span class="entity">constraint</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">constraint</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Unknown variable prefix."</span><span class="main">,</span> <span class="main">[</span><span class="entity">var</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">parseVar</span> <span class="main">_</span> <span class="main">_</span> <span class="entity">var</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected constrained free variable."</span><span class="main">,</span> <span class="entity">var</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">constrainTrm</span> <span class="entity">ctxt</span> <span class="entity">forceMeta</span> <span class="entity">unary</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">var</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">trm</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fetchTermConstraint</span> <span class="entity">ctxt</span> <span class="entity">var</span> <span class="entity">unary</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="main">(</span><span class="entity">AOT_MetaVariable</span><span class="main">,</span><span class="entity">constraint</span><span class="main">)</span> <span class="main">=&gt;</span> Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">trm</span> $ <span class="entity">constraint</span>
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">AOT_Variable</span> <span class="entity">restr</span><span class="main">,</span> <span class="entity">constraint</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">forceMeta</span> <span class="keyword2"><span class="keyword">then</span></span> Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">trm</span> $ <span class="entity">constraint</span>
          <span class="keyword2"><span class="keyword">else</span></span> Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹AOT_term_of_var›</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">restr</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">r</span> $ <span class="entity">trm</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">trm</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">constraint</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Unknown variable or metavariable prefix."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">constrainTrm</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">(</span>Bound <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">var</span> <span class="main">=&gt;</span> <span class="entity">var</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">constrainTrm</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="entity">trm</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected free or bound variable."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isPremiseVar</span> <span class="entity">ctxt</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">var</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">AOT_IsPremiseSetPrefix</span> <span class="entity">ctxt</span> <span class="main">(</span>hd <span class="main">(</span>Symbol.explode <span class="entity">var</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">isPremiseVar</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> false
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">getVarConstraint</span> <span class="entity">ctxt</span> <span class="entity">unary</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">var</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fetchTermConstraint</span> <span class="entity">ctxt</span> <span class="entity">var</span> <span class="entity">unary</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="main">(</span><span class="entity">AOT_MetaVariable</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> NONE
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">AOT_Variable</span> <span class="entity">Rep_term</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> Option.map fst <span class="entity">Rep_term</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
  <span class="main">|</span> <span class="entity">getVarConstraint</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> NONE
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_term_var›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">getVarConstraint</span> <span class="entity">ctxt</span> true <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">c</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_AOT_term_vars"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">getVarConstraint</span> <span class="entity">ctxt</span> true <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">c</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">getVarConstraints</span> <span class="main">_</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_verbatim›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span>  <span class="main">=</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="entity">x</span> @ <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="entity">y</span>
  <span class="main">|</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="entity">z</span>
  <span class="main">|</span> <span class="entity">getVarConstraints</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_term_var›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isPremiseVar</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">,</span> <span class="keyword2"><span class="keyword">if</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">premiseVars</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">v</span>::<span class="entity">premiseVars</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">premiseVars</span><span class="main">)</span>
                         <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">constrainTrm</span> <span class="entity">ctxt</span> <span class="entity">forceMeta</span> true <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_AOT_term_vars"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isPremiseVar</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="keyword2"><span class="keyword">if</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">premiseVars</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">v</span>::<span class="entity">premiseVars</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">premiseVars</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">constrainTrm</span> <span class="entity">ctxt</span> <span class="entity">forceMeta</span> false <span class="main">(</span><span class="entity">dropConstraints</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span>
  <span class="main">)</span>
  <span class="main">|</span> <span class="entity">processFreesForceMeta</span> <span class="main">_</span> <span class="entity">premiseVars</span> <span class="main">_</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_verbatim›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span>  <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span> <span class="main">=</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="entity">x</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span> <span class="main">=</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="entity">y</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">x</span> $ <span class="entity">y</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="entity">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">z</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span> <span class="main">=</span> <span class="entity">processFreesForceMeta</span> <span class="entity">forceMeta</span> <span class="entity">premiseVars</span> <span class="entity">ctxt</span> <span class="entity">z</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="entity">z</span><span class="main">)</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">processFreesForceMeta</span> <span class="main">_</span> <span class="entity">premiseVars</span> <span class="main">_</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">premiseVars</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">processFrees</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">processFreesForceMeta</span> false <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"No premise set expected in term."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">processFreesAlwaysMeta</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">processFreesForceMeta</span> true <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"No premise set expected in term."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">processFreesAndPremises</span> <span class="main">=</span> <span class="entity">processFreesForceMeta</span> false <span class="main">[</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">makeArgList</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_exe_args›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">y</span> $ <span class="entity">z</span><span class="main">)</span> <span class="main">=</span> <span class="entity">makeArgList</span> <span class="entity">y</span> @ <span class="entity">makeArgList</span> <span class="entity">z</span>
  <span class="main">|</span> <span class="entity">makeArgList</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">makePairs</span> <span class="main">(</span><span class="entity">x</span>::<span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">makePairs</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹Pair›</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">makePairs</span> <span class="entity">xs</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">makeExeArgs</span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">makePairs</span> <span class="main">(</span><span class="entity">makeArgList</span> <span class="entity">y</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">foldPremises</span> <span class="entity">world</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_premises›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p1</span> $ <span class="entity">p2</span><span class="main">)</span> <span class="entity">y</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Pure.imp"<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">p1</span> $ <span class="entity">world</span><span class="main">)</span> $ <span class="entity">foldPremises</span> <span class="entity">world</span> <span class="entity">p2</span> <span class="entity">y</span>
<span class="main">|</span> <span class="entity">foldPremises</span> <span class="entity">world</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Pure.imp"<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">x</span> $ <span class="entity">world</span><span class="main">)</span> $ <span class="entity">HOLogic.mk_Trueprop</span>  <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> AOT_model_valid_in<span class="antiquote">}</span></span> $ <span class="entity">world</span> $ <span class="entity">y</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseExe</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_exe›</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">makeExeArgs</span> <span class="entity">y</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseEnc</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"AOT_enc"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">makeExeArgs</span> <span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseEquivDef</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">rhs</span><span class="main">]</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">constraints</span> <span class="main">=</span> <span class="entity">getVarConstraints</span> <span class="entity">ctxt</span> <span class="entity">lhs</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">collectConstraints</span> <span class="entity">c</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">c</span>
     <span class="main">|</span> <span class="entity">collectConstraints</span> NONE <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">collectConstraints</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
     <span class="main">|</span> <span class="entity">collectConstraints</span> <span class="main">(</span>SOME <span class="entity">c</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">collectConstraints</span> <span class="main">(</span>SOME <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"AOT_conj"</span><span class="main">,</span> dummyT<span class="main">)</span> $  <span class="entity">c</span> $ <span class="main">(</span><span class="entity">x</span> $ <span class="entity">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">collectConstraints</span> NONE <span class="entity">constraints</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">c</span> <span class="main">=&gt;</span> Const <span class="main">(</span><span class="inner_quoted">"AOT_conj"</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">c</span> $ <span class="entity">rhs</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">rhs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span>‹AOT_model_equiv_def›</span> $ <span class="entity">processFreesAlwaysMeta</span> <span class="entity">ctxt</span> <span class="entity">lhs</span> $ <span class="entity">processFreesAlwaysMeta</span> <span class="entity">ctxt</span> <span class="entity">rhs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">parseEquivDef</span> <span class="main">_</span> <span class="entity">terms</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected definition arguments."</span><span class="main">,</span> <span class="entity">terms</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseIdDef</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">]</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> <span class="entity">processFreesAlwaysMeta</span> <span class="entity">ctxt</span> <span class="entity">lhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs</span> <span class="main">=</span> <span class="entity">processFreesAlwaysMeta</span> <span class="entity">ctxt</span> <span class="entity">rhs</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_frees</span> <span class="main">(</span>Free <span class="main">_</span><span class="main">)</span> <span class="entity">frees</span> <span class="main">=</span> <span class="entity">frees</span>
      <span class="main">|</span> <span class="entity">add_frees</span> <span class="main">(</span>Const <span class="main">_</span><span class="main">)</span> <span class="entity">frees</span> <span class="main">=</span> <span class="entity">frees</span>
      <span class="main">|</span> <span class="entity">add_frees</span> <span class="main">(</span>Free <span class="main">_</span> $ <span class="entity">args</span><span class="main">)</span> <span class="entity">frees</span> <span class="main">=</span> Term.add_frees <span class="entity">args</span> <span class="entity">frees</span>
      <span class="main">|</span> <span class="entity">add_frees</span> <span class="main">(</span>Const <span class="main">_</span> $ <span class="entity">args</span><span class="main">)</span> <span class="entity">frees</span> <span class="main">=</span> Term.add_frees <span class="entity">args</span> <span class="entity">frees</span>
      <span class="main">|</span> <span class="entity">add_frees</span> <span class="main">(</span><span class="entity">args</span> $ <span class="entity">args'</span><span class="main">)</span> <span class="entity">frees</span> <span class="main">=</span> Term.add_frees <span class="entity">args'</span> <span class="main">(</span>Term.add_frees <span class="entity">args</span> <span class="entity">frees</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">add_frees</span> <span class="entity">trm</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected definition term."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs'</span> <span class="main">=</span> <span class="entity">dropConstraints</span> <span class="entity">lhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs'</span> <span class="main">=</span> <span class="entity">dropConstraints</span> <span class="entity">rhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">frees</span> <span class="main">=</span> <span class="entity">add_frees</span> <span class="entity">lhs'</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">frees</span> <span class="main">=</span> <span class="entity">add_frees</span> <span class="entity">rhs'</span> <span class="entity">frees</span> <span class="keyword1"><span class="keyword">orelse</span></span>
            <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Invalid free variables on RHS."</span><span class="main">,</span> <span class="main">[</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">rhs</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mkabs</span> <span class="entity">trm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">frees</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹case_unit›</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">trm</span> <span class="keyword2"><span class="keyword">else</span></span>
       fold_rev <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹case_prod›</span><span class="main">,</span> dummyT<span class="main">)</span> $ Term.absfree <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span>
                <span class="main">(</span>List.rev <span class="main">(</span>tl <span class="entity">frees</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Term.absfree <span class="main">(</span>hd <span class="entity">frees</span><span class="main">)</span> <span class="entity">trm</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs_abs</span> <span class="main">=</span> <span class="entity">mkabs</span> <span class="entity">lhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs_abs</span> <span class="main">=</span> <span class="entity">mkabs</span> <span class="entity">rhs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_constrain"</span><span class="main">,</span> dummyT<span class="main">)</span> $
     Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹AOT_model_id_def›</span><span class="main">,</span> dummyT<span class="main">)</span> $
     <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_syntax</span><span class="hidden">&gt;</span></span>‹fun›</span><span class="main">,</span> dummyT<span class="main">)</span> $
        <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_syntax</span><span class="hidden">&gt;</span></span>‹fun›</span><span class="main">,</span> dummyT<span class="main">)</span> $ Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_syntax</span><span class="hidden">&gt;</span></span>‹dummy›</span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="main">(</span><span class="entity">getConstraint</span> <span class="entity">ctxt</span> false <span class="inner_quoted">"Term"</span><span class="main">)</span><span class="main">)</span> $
        <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_syntax</span><span class="hidden">&gt;</span></span>‹dummy›</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>
    $ <span class="entity">lhs_abs</span> $ <span class="entity">rhs_abs</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">parseIdDef</span> <span class="main">_</span> <span class="entity">terms</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Expected definition arguments."</span><span class="main">,</span> <span class="entity">terms</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseEllipseList</span> <span class="entity">constName</span> <span class="main">_</span> <span class="main">[</span><span class="entity">s</span><span class="main">,</span><span class="entity">e</span><span class="main">]</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">start_name</span><span class="main">,</span> <span class="entity">start_pos</span><span class="main">)</span> <span class="main">=</span> <span class="entity">unconstrain_var</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">end_name</span><span class="main">,</span> <span class="entity">end_pos</span><span class="main">)</span> <span class="main">=</span> <span class="entity">unconstrain_var</span> <span class="entity">e</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">h</span> <span class="main">=</span> hd <span class="main">(</span>Symbol.explode <span class="entity">start_name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">h</span> <span class="main">=</span> hd <span class="main">(</span>Symbol.explode <span class="entity">end_name</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">h</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Ast.AST <span class="main">(</span><span class="inner_quoted">"Invalid ellipses."</span><span class="main">,</span> <span class="main">[</span><span class="entity">s</span><span class="main">,</span><span class="entity">e</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="main">(</span>Symbol_Pos.explode <span class="main">(</span><span class="entity">start_name</span><span class="main">,</span> <span class="entity">start_pos</span><span class="main">)</span><span class="main">)</span> @ <span class="main">(</span>Symbol_Pos.explode <span class="main">(</span><span class="entity">end_name</span><span class="main">,</span> <span class="entity">end_pos</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="entity">constName</span><span class="main">)</span> <span class="main">[</span><span class="entity">make_constrained_var</span> <span class="entity">name</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">parseEllipseList</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Invalid ellipse parsing."</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">PrintVarKind</span> <span class="main">=</span> <span class="entity">SingleVariable</span> <span class="keyword2"><span class="keyword">of</span></span> string <span class="main">|</span> <span class="entity">Ellipses</span> <span class="keyword2"><span class="keyword">of</span></span> string*string <span class="main">|</span> <span class="entity">Verbatim</span> <span class="keyword2"><span class="keyword">of</span></span> string

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">printVarKind</span> <span class="entity">name</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">splitFormulaParts</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span> |&gt; Symbol.explode |&gt;
   Scan.finite Symbol.stopper <span class="main">(</span>Scan.repeat <span class="main">(</span>
  <span class="main">(</span>Scan.one <span class="main">(</span>Symbol.is_letter<span class="main">)</span> --
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>Scan.repeat <span class="main">(</span>$$ <span class="inner_quoted">"⇩"</span> -- <span class="main">(</span>Scan.one <span class="main">(</span>Symbol.is_char<span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> &gt;&gt; List.concat <span class="main">)</span>
  -- <span class="main">(</span>Scan.repeat <span class="main">(</span>$$ <span class="inner_quoted">"'"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span>@<span class="entity">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parts</span> <span class="main">=</span> <span class="entity">splitFormulaParts</span> <span class="main">(</span>Name.clean <span class="entity">name</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">isSingleVariableName</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">parts</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="main">_</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
<span class="comment1">(* TODO: ellipses handling is very fragile *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">isEllipses</span><span class="main">,</span><span class="entity">s</span><span class="main">,</span><span class="entity">e</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">parts</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="entity">e</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span> <span class="main">=</span> <span class="entity">m</span><span class="main">,</span> <span class="entity">n</span>^String.concat <span class="entity">s</span><span class="main">,</span> <span class="entity">m</span>^String.concat <span class="entity">e</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>false<span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isSingleVariableName</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">SingleVariable</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">else</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isEllipses</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Ellipses</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">e</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Verbatim</span> <span class="entity">name</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">addFunct</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span> <span class="entity">g</span> <span class="main">=</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">g</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unconstrain</span> <span class="main">(</span>Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_constrain"</span>::<span class="entity">x</span>::<span class="entity">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">addFunct</span> <span class="main">(</span><span class="entity">unconstrain</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_constrain"</span>::<span class="entity">x</span>::<span class="entity">tl</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">unconstrain</span> <span class="main">(</span>Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_free"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">addFunct</span> <span class="main">(</span><span class="entity">unconstrain</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_free"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">unconstrain</span> <span class="main">(</span>Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_bound"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">addFunct</span> <span class="main">(</span><span class="entity">unconstrain</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_bound"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">unconstrain</span> <span class="main">(</span>Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_var"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">addFunct</span> <span class="main">(</span><span class="entity">unconstrain</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_var"</span>::<span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">unconstrain</span> <span class="entity">trm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">trm</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unmarkedName</span> <span class="main">=</span> Lexicon.unmark <span class="main">{</span>case_class <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">str</span> <span class="main">=&gt;</span> NONE<span class="main">,</span>
      case_type <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> NONE<span class="main">,</span>
      case_const <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> SOME <span class="entity">name</span><span class="main">,</span>
      case_fixed <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> NONE<span class="main">,</span>
      case_default <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> SOME <span class="entity">name</span><span class="main">}</span> <span class="entity">name</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cons</span> <span class="main">=</span> Option.mapPartial <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> try <span class="main">(</span>Proof_Context.read_const <span class="main">{</span>proper <span class="main">=</span> true<span class="main">,</span> strict <span class="main">=</span> true<span class="main">}</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">name</span><span class="main">)</span> <span class="entity">unmarkedName</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">defined</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">cons</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="entity">cons</span> <span class="main">=&gt;</span>
      Termtab.defined <span class="main">(</span>AOT_DefinedConstants.get <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">cons</span>
      <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">cons</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> AOT_concrete<span class="antiquote">}</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">defined</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">AOT_print_individual_term</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_term_of_var›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_desc›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_free_var_ellipse›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Constant <span class="main">_</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">unconstrain</span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> 
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">printVarKind</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">SingleVariable</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">)</span> <span class="main">|</span>
                    <span class="entity">Ellipses</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_exe_arg_ellipse›</span><span class="main">)</span> <span class="main">[</span>
                <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">x</span><span class="main">)</span><span class="main">,</span>
                <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">)</span> 
        <span class="main">|</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">c</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">|</span>  <span class="main">(</span><span class="entity">trm'</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="entity">name</span>::<span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">c</span> <span class="entity">trm'</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span>  <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">trms</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="entity">trms</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">AOT_print_relation_term</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_term_of_var›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_explicitRelation›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_lambda›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_lambda›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">unconstrain</span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> 
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">printVarKind</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">SingleVariable</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_explicitRelation›</span><span class="main">)</span> <span class="main">[</span><span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
                  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">)</span> 
        <span class="main">|</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">c</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">|</span>  <span class="main">(</span><span class="entity">trm'</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="entity">name</span>::<span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_explicitRelation›</span><span class="main">)</span> <span class="main">[</span><span class="entity">c</span> <span class="entity">trm'</span><span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span>  <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">trms</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="entity">trms</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">AOT_print_generic_term</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_term_of_var›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_explicitRelation›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_desc›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_free_var_ellipse›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_lambda›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span>‹AOT_lambda›</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_AOT_raw_appl"</span>::<span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">trm</span>
    <span class="main">|</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">unconstrain</span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> 
                  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">printVarKind</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">SingleVariable</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">name</span><span class="main">)</span> <span class="main">|</span>
                    <span class="entity">Ellipses</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_exe_arg_ellipse›</span><span class="main">)</span> <span class="main">[</span>
                <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">x</span><span class="main">)</span><span class="main">,</span>
                <span class="entity">c</span> <span class="main">(</span>Ast.Variable <span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">)</span> 
        <span class="main">|</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">c</span> <span class="main">(</span>Ast.Constant <span class="entity">name</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span>
        <span class="main">|</span>  <span class="main">(</span><span class="entity">trm'</span> <span class="keyword1"><span class="keyword">as</span></span> Ast.Appl <span class="main">(</span>Ast.Constant <span class="entity">name</span>::<span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">isDefinedConst</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">c</span> <span class="entity">trm'</span> <span class="keyword2"><span class="keyword">else</span></span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span>  <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">trms</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_quoted›</span><span class="main">)</span> <span class="entity">trms</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_preserve_binder_abs_tr'</span> <span class="entity">constName</span> <span class="entity">syntaxConst</span> <span class="main">(</span><span class="entity">ellipseConst</span><span class="main">,</span><span class="entity">includesSyntaxConst</span><span class="main">)</span> <span class="entity">restrConnect</span> <span class="main">=</span> 
<span class="main">(</span><span class="entity">constName</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">terms</span> <span class="main">=&gt;</span>
<span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_opt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">terms</span> <span class="keyword2"><span class="keyword">of</span></span> Abs <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">trm</span><span class="main">)</span>::<span class="entity">trms</span> <span class="main">=&gt;</span> 
<span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">printVarKind</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">SingleVariable</span> <span class="entity">name</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">optBody</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fetchTermCategory</span> <span class="entity">ctxt</span> <span class="main">(</span>hd <span class="main">(</span>Symbol.explode <span class="main">(</span><span class="entity">name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="entity">AOT_Variable</span> <span class="main">_</span><span class="main">,</span> <span class="entity">category</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">restr</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Local_Theory.raw_theory_result <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">(</span>Symtab.lookup <span class="main">(</span>AOT_Restriction.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">category</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">restr</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">restr</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">trm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">trm</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">c</span> <span class="main">=</span> <span class="entity">restrConnect</span> <span class="keyword1"><span class="keyword">orelse</span></span> Lexicon.unmark_const <span class="entity">c</span> <span class="main">=</span> <span class="entity">restrConnect</span> <span class="comment1">(* TODO: better matching *)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">then</span></span>
                <span class="comment1">(* TODO: is this matching good enough? *)</span>
                <span class="keyword2"><span class="keyword">if</span></span> Term.could_unify <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span> dummyT<span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">,</span> Abs <span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span> dummyT<span class="main">,</span>  Term.betapply <span class="main">(</span>fst <span class="entity">restr</span><span class="main">,</span><span class="main">(</span>Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
                  SOME <span class="entity">trm</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  NONE
              <span class="keyword2"><span class="keyword">else</span></span> NONE <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE
        <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">terms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">optBody</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">trm</span> <span class="main">=&gt;</span> Abs <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">trm</span><span class="main">)</span>::<span class="entity">trms</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">trms</span>
    <span class="keyword2"><span class="keyword">in</span></span>
        snd <span class="main">(</span>Syntax_Trans.preserve_binder_abs_tr' <span class="entity">constName</span> <span class="entity">syntaxConst</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">terms</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">Ellipses</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
     <span class="comment1">(* TODO: ellipses that are fix'ed loose their markup - try to circumvent *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">body</span> <span class="main">=</span> Term.subst_bound <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span>‹_AOT_free_var_ellipse›</span><span class="main">,</span> dummyT<span class="main">)</span> $ Syntax_Trans.mark_bound_body <span class="main">(</span><span class="entity">s</span><span class="main">,</span>dummyT<span class="main">)</span> $ Syntax_Trans.mark_bound_body <span class="main">(</span><span class="entity">e</span><span class="main">,</span>dummyT<span class="main">)</span><span class="main">,</span>
    <span class="entity">trm</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">includesSyntaxConst</span> <span class="keyword2"><span class="keyword">then</span></span>
        list_comb <span class="main">(</span>Syntax.const <span class="entity">ellipseConst</span> $ Syntax_Trans.mark_bound_abs <span class="main">(</span><span class="entity">s</span><span class="main">,</span>dummyT<span class="main">)</span> $ 
        Syntax_Trans.mark_bound_abs <span class="main">(</span><span class="entity">e</span><span class="main">,</span>dummyT<span class="main">)</span> $ <span class="entity">body</span><span class="main">,</span> <span class="entity">trms</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        list_comb <span class="main">(</span>Syntax.const <span class="entity">syntaxConst</span> $ <span class="main">(</span>Syntax.const <span class="entity">ellipseConst</span> $ Syntax_Trans.mark_bound_abs <span class="main">(</span><span class="entity">s</span><span class="main">,</span>dummyT<span class="main">)</span> $ 
        Syntax_Trans.mark_bound_abs <span class="main">(</span><span class="entity">e</span><span class="main">,</span>dummyT<span class="main">)</span><span class="main">)</span> $ <span class="entity">body</span><span class="main">,</span> <span class="entity">trms</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">Verbatim</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="comment1">(* TODO *)</span>
    snd <span class="main">(</span>Syntax_Trans.preserve_binder_abs_tr' <span class="entity">constName</span> <span class="entity">syntaxConst</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">terms</span>
<span class="keyword2"><span class="keyword">in</span></span> SOME <span class="entity">trm</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword2"><span class="keyword">case</span></span> <span class="entity">term_opt</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">trm</span> <span class="main">=&gt;</span> <span class="entity">trm</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span>
snd <span class="main">(</span>Syntax_Trans.preserve_binder_abs_tr' <span class="entity">constName</span> <span class="entity">syntaxConst</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">terms</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AOT_restricted_binder</span> <span class="entity">const</span> <span class="entity">connect</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">]</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="entity">const</span><span class="main">)</span> <span class="main">[</span>
<span class="keyword2"><span class="keyword">let</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">b</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Ast.Appl <span class="main">[</span>Ast.Constant <span class="inner_quoted">"_AOT_var"</span><span class="main">,</span> <span class="entity">var</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>
<span class="keyword2"><span class="keyword">case</span></span> <span class="entity">fetchTermCategory</span> <span class="entity">ctxt</span> <span class="main">(</span>hd <span class="main">(</span>Symbol.explode <span class="main">(</span>fst <span class="main">(</span><span class="entity">unconstrain_var</span> <span class="entity">var</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="entity">AOT_Variable</span> <span class="main">_</span><span class="main">,</span> <span class="entity">category</span><span class="main">)</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">restr</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Local_Theory.raw_theory_result <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thy</span> <span class="main">=&gt;</span> <span class="main">(</span>Symtab.lookup <span class="main">(</span>AOT_Restriction.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">category</span><span class="main">,</span> <span class="entity">thy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">restr</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">_</span> <span class="main">=&gt;</span> Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="entity">connect</span><span class="main">)</span> <span class="main">[</span>Ast.mk_appl <span class="main">(</span>Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_AOT_restriction"</span><span class="main">)</span> <span class="main">[</span>Ast.Constant <span class="entity">category</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="entity">a</span><span class="main">]</span><span class="main">,</span> <span class="entity">b</span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">end</span></span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">b</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">b</span>
<span class="keyword2"><span class="keyword">in</span></span>
  Ast.mk_appl <span class="main">(</span>Ast.Constant <span class="inner_quoted">"_abs"</span><span class="main">)</span>  <span class="main">[</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">]</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parseDDOT</span> <span class="entity">ctxt</span> <span class="main">_</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trm</span> <span class="main">=</span> Proof_Context.get_fact_single <span class="entity">ctxt</span> <span class="main">(</span>Facts.named <span class="main">(</span>Long_Name.localN ^ Long_Name.separator ^ Auto_Bind.thisN<span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trm</span> <span class="main">=</span> Thm.concl_of <span class="entity">trm</span>
    <span class="comment1">(* TODO: find a proper way to do this *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mapTerms</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> List.rev <span class="main">(</span>String.explode <span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="inner_quoted">#"_"</span> :: <span class="inner_quoted">#"_"</span> :: <span class="entity">tl</span> <span class="main">=&gt;</span>
      Free <span class="main">(</span>String.implode <span class="main">(</span>List.rev <span class="entity">tl</span><span class="main">)</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">typ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">mapTerms</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trm</span> <span class="main">=</span> Term.map_aterms <span class="entity">mapTerms</span> <span class="entity">trm</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">readThisRHS</span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.Trueprop"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"AOT_model.AOT_model_valid_in"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">(</span>Const <span class="main">_</span> $ <span class="main">_</span> $ <span class="entity">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">rhs</span>
      <span class="main">|</span> <span class="entity">readThisRHS</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Term.TERM <span class="main">(</span><span class="inner_quoted">"Could not expand ... from term."</span><span class="main">,</span> <span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">readThisRHS</span> <span class="entity">trm</span>
  <span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>