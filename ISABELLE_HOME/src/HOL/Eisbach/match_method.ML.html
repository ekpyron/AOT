<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹match_method.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹match_method.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Eisbach/match_method.ML
    Author:     Daniel Matichuk, NICTA/UNSW

Setup for "match" proof method. It provides basic fact/term matching in
addition to premise/conclusion matching through Subgoal.focus, and binds
fact names from matches as well as term patterns within matches.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>MATCH_METHOD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> focus_schematics</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Envir.tenv</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> focus_params</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="comment1"><span>(* FIXME proper ML interface for the main thing *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Match_Method</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MATCH_METHOD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* Filter premises by predicate, with premise order; recovers premise order afterwards.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_prems_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>Then</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Then</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tac'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>tac'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thins</span></span><span> </span><span class="entity"><span>idxH</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="entity"><span>idxH</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Then</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span>rotate_tac</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>THEN'</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>thin_rl</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idxHs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_hyp</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>thins</span></span><span> </span><span class="entity"><span>idxHs</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>rotate_tac</span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>match_kind</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Match_Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term Item_Net.T
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Fact</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm Item_Net.T
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Concl</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bool</span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aconv_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span>single</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_match_kind</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>conclusion</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Match_Concl</span></span><span> </span><span>||</span><span>
  </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>premises</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.mode</span><span> </span><span class="inner_quoted"><span>"local"</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Match_Prems</span></span><span> </span><span>||</span><span>
  </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Args.term</span><span> </span><span>--|</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Match_Term</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>aconv_net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span>
  </span><span class="entity"><span>Attrib.thms</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Match_Fact</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>Thm.item_net</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nameable_match</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Match_Fact</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Prems</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prop_match</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Match_Term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_thm</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Parse_Tools.parse_val</span></span><span> </span><span>parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Parse_Tools.parse_thm_val</span></span><span> </span><span>Parse.binding</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_term</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Parse_Tools.parse_val</span></span><span> </span><span>parser</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Parse_Tools.parse_term_val</span></span><span> </span><span>Parse.binding</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Parse.and_list1</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span class="entity"><span>bound_term</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
    </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>::</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span>Parse.typ</span><span class="main"><span>)</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>for_fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pos_of</span></span><span> </span><span class="entity"><span>dyn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Parse_Tools.the_parse_val</span></span><span> </span><span class="entity"><span>dyn</span></span><span> </span><span>|&gt;</span><span> </span><span>Binding.pos_of</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*FIXME: Dynamic facts modify the background theory, so we have to resort
  to token replacement for matched facts. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dynamic_fact</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.lift</span><span> </span><span class="entity"><span>bound_thm</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Attrib.opt_attribs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>match_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>multi </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span> cut </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_match_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span>
    </span><span class="main"><span>(</span></span><span>Args.parens</span><span>
      </span><span class="main"><span>(</span></span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>","</span></span><span>
        </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"multi"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>cut</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>multi </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> cut </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span>
         </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"cut"</span></span><span> </span><span>|--</span><span> </span><span>Scan.optional</span><span> </span><span>Parse.nat</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>multi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>multi </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>multi</span></span><span class="main"><span>,</span></span><span> cut </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>I</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>{</span></span><span>multi </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> cut </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_named_pats</span></span><span> </span><span class="entity"><span>match_kind</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Args.context</span><span> </span><span>--</span><span>
  </span><span>Parse.and_list1'</span><span>
    </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dynamic_fact</span></span><span> </span><span>--|</span><span> </span><span>Scan.lift</span><span> </span><span>Args.colon</span><span class="main"><span>)</span></span><span> </span><span>:--</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>opt_dyn</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>opt_dyn</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>nameable_match</span></span><span> </span><span class="entity"><span>match_kind</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.name_term</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_match_args</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_dyn</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cannot bind fact name in term match"</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos_of</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
  </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>for_fixes</span></span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>⇒</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.token</span><span> </span><span>Parse.embedded</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Token.get_value</span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.Source</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.read</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.Real_Val</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.the_real_val</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Expected closed term"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Parse_Tools.the_real_val</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixes'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fix_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Proof_Context.add_fixes_cmd</span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>otyp</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.the_parse_val</span></span><span> </span><span class="entity"><span>pb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>otyp</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span>
            </span><span>||&gt;</span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_schematic</span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prop_match</span></span><span> </span><span class="entity"><span>match_kind</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Syntax.parse_prop</span><span> </span><span class="entity"><span>ctxt3</span></span><span> </span><span class="entity"><span>term</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>ctxt3</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_judgment_dummy</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>judgment</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
                </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_type_constraint_›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
                  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.dummy_pattern</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>judgment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Object_Logic.judgment_name</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_type_constraint_›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
                      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.dummy_pattern</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>propT</span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>drop_judgment_dummy</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>drop_judgment_dummy</span></span><span> </span><span class="entity"><span>t2</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>drop_judgment_dummy</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.the_parse_val</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>drop_judgment_dummy</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_map</span><span> </span><span>Term.replace_dummy_patterns</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.maxidx_of</span><span> </span><span class="entity"><span>ctxt3</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fst</span><span>
            </span><span>|&gt;</span><span> </span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt3</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_fixes</span></span><span> </span><span class="entity"><span>nm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"For-fixed variable must be bound in some pattern"</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>fix_names</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.map_types</span><span> </span><span>Type.no_tvars</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>ctxt3</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>real_fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt5</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt4</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span>Proof_Context.inferred_param</span><span> </span><span class="entity"><span>fix_names</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span>Free</span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reject_extra_free</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Variable.is_fixed</span><span> </span><span class="entity"><span>ctxt5</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Illegal use of free (unfixed) variable "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reject_extra_free</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>o</span><span> </span><span>fold_aterms</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reject_extra_free</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binds</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Tools.the_parse_val</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>upd_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>nm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span>Name.internal</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_nms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_all_vars</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Drule.mk_term</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs_nms</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Conjunction.intr_balanced</span><span>
                    </span><span>|&gt;</span><span> </span><span>Drule.generalize</span><span> </span><span class="main"><span>(</span></span><span>Names.empty</span><span class="main"><span>,</span></span><span> </span><span>Names.make_set</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>abs_nms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Thm.tag_free_dummy</span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_thm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.proof_attributes</span><span> </span><span class="entity"><span>atts</span></span><span> </span><span class="entity"><span>param_thm</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>label_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nm</span></span><span class="main"><span>,</span></span><span> </span><span>propT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Drule.mk_term</span><span>
                    </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>abs_nms</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>Conjunction.intr</span><span> </span><span class="entity"><span>thm</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>head_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>Drule.zero_var_indexes_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>label_thm</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>param_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param_thm'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Thm.tag_free_dummy</span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'''</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="entity"><span>Attrib.local_notes</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>body_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>snd</span><span>
                    </span><span>|&gt;</span><span> </span><span>Variable.declare_maxidx</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>head_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'''</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>upd_ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span> </span><span>::</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt6</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt5</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold2</span><span> </span><span class="entity"><span>upd_ctxt</span></span><span> </span><span class="entity"><span>binds</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span>
            </span><span>||&gt;</span><span> </span><span>Proof_Context.restore_mode</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.read_closure_input</span></span><span> </span><span class="entity"><span>ctxt6</span></span><span> </span><span class="main"><span>(</span></span><span>Token.input_of</span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Variable.export_morphism</span><span> </span><span class="entity"><span>ctxt6</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span>
                </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Token.declare_maxidx</span><span> </span><span class="entity"><span>src</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Variable.declare_maxidx</span><span> </span><span class="main"><span>(</span></span><span>Variable.maxidx_of</span><span> </span><span class="entity"><span>ctxt6</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.map_types</span><span> </span><span>Type_Infer.paramify_vars</span><span> </span><span>#&gt;</span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ListPair.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Parse_Tools.the_parse_fun</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_src</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>src'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Token.closure</span><span> </span><span>#&gt;</span><span> </span><span>Token.transform</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span>Token.args_of_src</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>~~</span><span> </span><span>Token.args_of_src</span><span> </span><span class="entity"><span>src'</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tok'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Token.get_value</span><span> </span><span class="entity"><span>tok'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ignore</span><span> </span><span class="main"><span>(</span></span><span>Token.assign</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>src'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binds'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>close_src</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binds</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>ListPair.app</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Parse_Tools.the_parse_fun</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Mismatch between real and parsed bound variables"</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binds'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>real_fixes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>real_fixes</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>ListPair.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Parse_Tools.the_parse_fun</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>real_fixes'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>match_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binds''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binds'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>pats'</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>src'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Token.transform</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Token.assign</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.Source</span><span> </span><span class="entity"><span>src'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>binds''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>real_fixes'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_internal_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>Logic.dest_conjunction</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_conjunctions</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Logic.dest_term</span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>head</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_term</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_internal_fact</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_internal_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_term</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>dest_Var</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_inst</span></span><span> </span><span class="entity"><span>fact_insts'</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact_insts'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_dest_term</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">try</span><span class="hidden">&gt;</span></span></span><span class="entity"><span>‹</span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_internal_fact</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>›</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_fact</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_dest_term</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>t_ident</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="entity"><span>t_ident</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_morphism</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Morphism.term_morphism</span><span> </span><span class="inner_quoted"><span>"do_inst.term"</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_term</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span>$&gt;</span><span>
      </span><span>Morphism.typ_morphism</span><span> </span><span class="inner_quoted"><span>"do_inst.type"</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="main"><span>(</span></span><span>Envir.type_env</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$&gt;</span><span>
      </span><span>Morphism.fact_morphism</span><span> </span><span class="inner_quoted"><span>"do_inst.fact"</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expand_fact</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_attribute</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fact_morphism</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Token.transform</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>Thm.proof_attributes</span><span> </span><span class="entity"><span>atts'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact''</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fact_insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

     </span><span class="comment1"><span>(*TODO: What to do about attributes that raise errors?*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_insts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_attribute</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>text'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.map_source</span></span><span> </span><span>o</span><span> </span><span>map</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Token.transform</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_morphism</span></span><span> </span><span class="entity"><span>fact_insts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>text'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_fact_pat</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.focus</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Variable.export_morphism</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Variable.declare_maxidx</span><span> </span><span class="main"><span>(</span></span><span>Variable.maxidx_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat''</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_internal_fact</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>att</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>prep_head</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params''</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat''</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morphism_env</span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.term_env</span><span> </span><span class="entity"><span>env</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Vartab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.typ</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.type_env</span><span> </span><span class="entity"><span>env</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Vartab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span>maxidx </span><span class="main"><span>=</span></span><span> </span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> tenv </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> tyenv </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyenv</span></span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>export_with_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morphism_env</span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>outer_env</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>export_with_params</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_filter_env</span></span><span> </span><span class="entity"><span>is_newly_fixed</span></span><span> </span><span class="entity"><span>pat_vars</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Term.dest_Var</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.term_env</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="entity"><span>xi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_vars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Term.dest_Var</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.keys</span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xi'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xi'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes_vars</span></span><span> </span><span class="entity"><span>all_vars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Vartab.delete_safe</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_vars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span>maxidx </span><span class="main"><span>=</span></span><span> </span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> tenv </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tenv'</span></span><span class="main"><span>,</span></span><span> tyenv </span><span class="main"><span>=</span></span><span> </span><span>Envir.type_env</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_params_bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_newly_fixed</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_params_distinct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>has_duplicates</span><span> </span><span class="main"><span>(</span></span><span>eq_option</span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>inter</span><span> </span><span class="main"><span>(</span></span><span>eq_fst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes_vars</span></span><span> </span><span class="entity"><span>pat_vars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_pat_fixes_bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tenv'</span></span><span> </span><span class="entity"><span>xi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_fixes</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_params_bound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>all_pat_fixes_bound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>all_params_distinct</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>env'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Slightly hacky way of uniquely identifying focus premises *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_idN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"premise_id"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prem_id_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id'</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_rules</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Item_Net.T</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.init</span><span> </span><span class="entity"><span>prem_id_eq</span></span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>Thm.full_prop_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_thm_to_id</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Properties.get</span><span> </span><span class="main"><span>(</span></span><span>Thm.get_tags</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem_idN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int.fromString</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Focus_Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>)</span></span><span> *  </span><span class="comment1"><span>(*prems*)</span></span><span>
    </span><span>Envir.tenv</span><span> *  </span><span class="comment1"><span>(*schematics*)</span></span><span>
    </span><span>term</span><span> </span><span>list</span><span>  </span><span class="comment1"><span>(*params*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prem_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* focus prems *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>focus_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Focus_Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_focus_prems</span></span><span> </span><span class="entity"><span>from_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Focus_Data.map</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus_prems</span></span><span> </span><span class="entity"><span>from_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_focus_prem</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>`</span><span class="main"><span>(</span></span><span>Focus_Data.get</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>##&gt;</span><span>
  </span><span class="main"><span>(</span></span><span>Focus_Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Item_Net.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.tag_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem_idN</span></span><span class="main"><span>,</span></span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_focus_prem'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ident</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Focus_Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Item_Net.remove</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ident</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_focus_prem</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>remove_focus_prem'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_thm_to_id</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*TODO: Preliminary analysis to see if we're trying to clear in a non-focus match?*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Eisbach.thin|attribute"><span>thin</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span>
        </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.mapping</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_focus_prem</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="inner_quoted"><span>"clear premise inside match method"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* focus schematics *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>focus_schematics</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span>Focus_Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_focus_schematics</span></span><span> </span><span class="entity"><span>schematics</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Focus_Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>2</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* focus params *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>focus_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>o</span><span> </span><span>Focus_Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_focus_params</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Focus_Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>3</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>append</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Add focus elements as proof data *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>augment_focus</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Subgoal.focus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem_ids</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_focus_params</span></span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_focus_schematics</span></span><span> </span><span class="main"><span>(</span></span><span>Vars.dest</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>add_focus_prem</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>prem_ids</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span>
       params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span>
       prems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
       concl </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span>
       schematics </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>,</span></span><span>
       asms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Fix schematics in the goal *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>focus_concl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Subgoal.focus_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import_inst</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematic_terms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vars.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="entity"><span>schematic_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate_cterm</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="entity"><span>schematic_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schematic_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematic_terms'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematics</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematics'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schematic_types</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span>Vars.add</span><span> </span><span class="entity"><span>schematic_terms</span></span><span> </span><span class="entity"><span>schematic_terms'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span> concl </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl'</span></span><span class="main"><span>,</span></span><span> params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
      schematics </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematics'</span></span><span class="main"><span>,</span></span><span> asms </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deduplicate</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deduplicate</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deduplicate</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prev</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consistent_env</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.term_env</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.type_env</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Envir.norm_type</span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.dest</span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Envir.eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_term</span><span> </span><span class="entity"><span>env1</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span>aconv</span><span>
  </span><span>Envir.eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_term</span><span> </span><span class="entity"><span>env2</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Envir.norm_type</span><span> </span><span class="main"><span>(</span></span><span>Envir.type_env</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.norm_type</span><span> </span><span class="main"><span>(</span></span><span>Envir.type_env</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
    </span><span>ListPair.allEq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>term_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>Vartab.dest</span><span> </span><span class="main"><span>(</span></span><span>Envir.term_env</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.term_env</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
    </span><span>ListPair.allEq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>type_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>Vartab.dest</span><span> </span><span class="main"><span>(</span></span><span>Envir.type_env</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.type_env</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vartab.merge</span><span> </span><span class="main"><span>(</span></span><span>eq_snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.term_env</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.term_env</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vartab.merge</span><span> </span><span class="main"><span>(</span></span><span>eq_snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_eq_wrt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>andf</span><span> </span><span>eq_fst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Envir.type_env</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.type_env</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env1</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.maxidx_of</span><span> </span><span class="entity"><span>env2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span>maxidx </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> tenv </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> tyenv </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyenv</span></span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>import_with_tags</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.map_tags</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Thm.get_tags</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>thms'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Vartab.DUP</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>Seq_retrieve</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>retrieve'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>retrieve'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>retrieve'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.append</span><span> </span><span class="main"><span>(</span></span><span>Seq.of_list</span><span> </span><span class="entity"><span>list</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>prop_pats</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_multi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>multi </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_cut</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>match_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>cut </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_cut</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.take</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop_pats</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_burrow</span><span> </span><span class="entity"><span>import_with_tags</span></span><span> </span><span class="entity"><span>raw_thmss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newly_fixed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.is_newly_fixed</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_morphism</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>item'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>Unify.matchers</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>item'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Seq.filter</span><span> </span><span class="entity"><span>consistent_env</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Seq.map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>match_filter_env</span></span><span> </span><span class="entity"><span>newly_fixed</span></span><span> </span><span class="entity"><span>pat_vars</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>env''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>export_with_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>morphism</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env''</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Thm.map_tags</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Thm.get_tags</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>deduplicate</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>eq_env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_matches</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span>pair</span><span> </span><span class="entity"><span>prop_pats</span></span><span> </span><span class="entity"><span>thmss</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>matches</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>matches</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc_multi_match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmenvs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>do_cut</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_cut</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_multi</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maximal_set</span></span><span> </span><span class="entity"><span>tail</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="entity"><span>envthms</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>envthms'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>Seq_retrieve</span></span><span> </span><span class="entity"><span>envthms</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>eq_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>        
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maximal_set</span></span><span> </span><span class="entity"><span>tail</span></span><span> </span><span class="entity"><span>seq'</span></span><span> </span><span class="entity"><span>envthms'</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maximal_set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tail</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seq'</span></span><span> </span><span class="entity"><span>envthms'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span>Seq.append</span><span> </span><span class="entity"><span>envthms</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.of_list</span><span> </span><span class="entity"><span>tail</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maximal_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maximal_set</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thmenvs</span></span><span> </span><span>Seq.empty</span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>maximal_sets</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span>swap</span><span>
            </span><span>|&gt;</span><span> </span><span>Seq.filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Seq.map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>env''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env''</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>just_one</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>env''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env''</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.append</span><span> </span><span class="main"><span>(</span></span><span>Seq.map_filter</span><span> </span><span class="entity"><span>just_one</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thmenvs</span></span><span> </span><span>Seq.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_matches</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Seq.EVERY</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>proc_multi_match</span></span><span> </span><span class="entity"><span>all_matches</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.init</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>all_matches</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morphism_env</span></span><span> </span><span class="entity"><span>morphism</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>real_match</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>              
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span>
      </span><span class="comment1"><span>(*FIXME Is this a good idea? We really only care about the maxidx*)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fact_matches</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>prep_fact_pat</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>match_facts</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>pats'</span></span><span> </span><span class="entity"><span>get</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_inst</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_term_matches</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Cannot name term match"</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_term</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.mk_term</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_term</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>thm_of</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>match_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>pats'</span></span><span> </span><span class="entity"><span>get'</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_inst</span></span><span> </span><span class="entity"><span>fact_insts</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Match_Fact</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>make_fact_matches</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.retrieve</span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Method.evaluate_runtime</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Seq.filter_results</span><span> </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Term</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>make_term_matches</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.retrieve</span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Method.evaluate_runtime</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Seq.filter_results</span><span> </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_kind</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.empty</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>focus_cases</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>match_kind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="entity"><span>Match_Prems</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>b</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Match_Concl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>g</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Match kind fell through"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>local_premids</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>focus_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focused_goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>focus_cases</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Subgoal.focus_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>focus_concl</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>st</span></span><span>
              </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>augment_focus</span></span><span class="main"><span>;</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>texts</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>focus_cases</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>is_local</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>make_fact_matches</span></span><span> </span><span class="entity"><span>focus_ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span>Item_Net.retrieve</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus_prems</span></span><span> </span><span class="entity"><span>focus_ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
                     </span><span>#&gt;</span><span> </span><span class="entity"><span>is_local</span></span><span> </span><span>?</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_premids</span></span><span class="main"><span>)</span></span><span>
                     </span><span>#&gt;</span><span> </span><span>order_list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>make_term_matches</span></span><span> </span><span class="entity"><span>focus_ctxt</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

            </span><span class="comment1"><span>(*TODO: How to handle cases? *)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_retrofit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inner_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>st1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>before_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>focus_prems</span></span><span> </span><span class="entity"><span>focus_ctxt</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>focus_prems</span></span><span> </span><span class="entity"><span>inner_ctxt</span></span><span class="main"><span>;</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>removed_prems</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>Item_Net.filter</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>Item_Net.lookup</span><span> </span><span class="entity"><span>after_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>before_prems</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>removed_local_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.content</span><span> </span><span class="entity"><span>removed_prems</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_premids</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>)</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_removed_prems</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>Item_Net.filter</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>Item_Net.lookup</span><span> </span><span class="entity"><span>removed_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
                                     
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> 
                  </span><span>|&gt;</span><span> </span><span>Focus_Data.map</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 3</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>filter_removed_prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n_subgoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st1</span></span><span class="main"><span>;</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>removed_prem_idxs</span></span><span> </span><span class="main"><span>=</span></span><span> 
                  </span><span class="entity"><span>prems</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>removed_local_prems</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span>

                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_prem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>removed_prem_idxs</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> 

              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>Subgoal.retrofit</span></span><span> </span><span class="entity"><span>inner_ctxt</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>asms</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>st1</span></span><span> </span><span class="entity"><span>st</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>focus_cases</span></span><span> 
                   </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n_subgoals</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>removed_local_prems</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span>
                    </span><span class="main"><span>(</span></span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>Goal.restrict</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>n_subgoals</span></span><span class="main"><span>)</span></span><span>
                      </span><span>#&gt;</span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span>DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_prems_tac'</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="entity"><span>filter_prem</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span>#&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>Goal.unrestrict</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>I</span><span>
                </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>outer_ctxt'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_text</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>Method.evaluate_runtime</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focused_goal</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.filter_results</span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span>Seq.DETERM</span><span> </span><span class="entity"><span>do_retrofit</span></span><span class="main"><span>)</span></span><span>             

          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.map</span><span> </span><span class="entity"><span>apply_text</span></span><span> </span><span class="entity"><span>texts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Eisbach.match|method"><span>match</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>parse_match_kind</span></span><span> </span><span>:--</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Scan.lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>in</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.enum1'</span><span> </span><span class="inner_quoted"><span>"¦"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_named_pats</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>matches</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bodies</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>CONTEXT_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Method.RUNTIME</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_focus_prems</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st'</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>real_match</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>st'</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Seq.flat</span><span> </span><span class="main"><span>(</span></span><span>Seq.FIRST</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>exec</span></span><span> </span><span class="entity"><span>bodies</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>transfer_focus_prems</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.make_results</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"structural analysis/matching on goals"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>